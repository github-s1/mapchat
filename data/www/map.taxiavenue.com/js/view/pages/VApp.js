/*  * Баги с фото:  * 1. сохраняется более 3-х изображений для значка *  */define(function(require){    "use strict";        var $ = require('jquery'),         Backbone = require('backbone'),        MApp = require('model/BaseModel'),        VCityPage = require('view/pages/VCityPage'),        VKindPage = require('view/pages/VKindPage'),        VMarkPage = require('view/pages/VMarkPage'),        VProfile = require('view/pages/VProfile'),        VErrorPage = require('view/pages/VErrorPage'),         VMarkAddingPage = require('view/pages/VMarkAddingPage'),         VSidebar = require('view/VSidebar'),        VMapMain = require('view/VMapMain'),                ThirdPartyMarks = require('model/ThirdPartyMarks').getInstance(),        VTopControl = require('view/VTopControl');        return Backbone.View.extend({                el          : $('body'),        page        : null,                events: {            "click"   :       "generalEventsHanler"        },                initialize: function(options) {            this.router = options.router;            this.model = new MApp({                selfUser: options.selfUser            });                        this.mainMap = new VMapMain({parent: this});            this.topControl = new VTopControl({                parent: this, model: this.model, chat: this.model.chat            });            this.sidebar = new VSidebar({parent: this});                        var self = this;            this.sidebar.defineLocation(false, function(coord){                self.mainMap.addMyLocation(coord, 1);            });//            this.sidebar.hideBlock();                        this.listenTo(this.model, 'changePage', this.setPage);            this.listenTo(this.model, 'changeMarkFilter', this.changeMarkFilter);            //            this._example();        },        changeMarkFilter: function(data) {            this.mainMap.addMarksToMap(data, false);        },        __example: function(){            $.ajax({                type: "POST",                data: { id_mark: 316 },                url: "http://185.159.129.150:8085/api/mark_json/Example",                success: function(res){                    console.log(res);                }            });        },                _definePage: function(pageName) {            var isClear = this.page ? true : false; // Если есть данные - по дефолту всегда очищаем страницу                        //! При переходе со страницы вида дублируется sideBar            //if (pageName == 'city' && isClear) this.sidebar = null;                                    if (isClear && pageName == 'markAdding' && this.page.pageName != 'markAdding') isClear = false; // При первом обращении к markAdding не чистим VCityPage            if(isClear){                this.clearPage();            }                        // На странице значка скрываем значки сторонних сервисов            if (pageName == 'kind') ThirdPartyMarks.showMarks = false;                else ThirdPartyMarks.showMarks = true;            var pageOptions = {parent: this};            switch(pageName){                case "city":                    this.page = new VCityPage(pageOptions);                    break;                case "kind":                    this.page = new VKindPage(pageOptions);                    break;                case "mark":                    this.page = new VMarkPage(pageOptions);                    break;                case "markAdding":                    this.page = new VMarkAddingPage(pageOptions);                    break;                case "profile":                    this.page = new VProfile(pageOptions);                    break;                case "error":                    this.page = new VErrorPage(pageOptions);                    break;            };        },                showCityPageState: function(data) {//            console.log("VApp/showCityPageState");            this.page.showState(data.city);            this.mainMap.addMarksToMap(data.marks);        },                showKindPageState: function(data){            this.router.showKindState(data);            if(data.marks){                this.mainMap.addMarksToMap(data.marks);            }        },                showMarkPageState: function(data){//            console.log(data);            this.topControl.setCityName(data.city.get("name_ru"));            this.router.showMarkState({                city: data.city.get("name_en"),                 kind: data.mark.get("kind").get("code"),                 id: data.mark.get("id")            });        },                showProfilePageState: function(data){            this.topControl.removeCityName();            this.router.showProfileState({                id: data.userId            });        },                // Создаем страницу        createPage: function(options) {            this._definePage(options.pageName);            this.page.create(options);        },                // Устанавливаем страницу из имеющихся данных        setPage: function(options) {            this._definePage(options.pageName);            this.page.set(options);            if (typeof (options.appInfo) != 'undefined') {                var navigateCity = options.appInfo.cityPage.location.city.name_en;                this.router.navigate(navigateCity, {trigger: false});            }            //window.history.pushState(null, null, '');        },                // Очистка данных страницы        clearPage: function() {            this.topControl.removeCityName();//            this.router.navigate("");            this.page.clear();        },                createSidebar: function() {            if(!this.sidebar){                this.sidebar = new VSidebar({parent: this, model: this.model});            }        },                removeSidebar: function() {            if(this.sidebar){                this.sidebar.remove();                this.sidebar = null;            }        },                /**         * Скрыть сайдбар значков, если он открыт         */        hideSidebar: function() {            if(!this.sidebar.$el.hasClass('hide')) this.sidebar.hideBlock();         },                /**         * Скрыть сайдбар значков, если он открыт         */        showSidebar: function() {            if(this.sidebar.$el.hasClass('hide')) this.sidebar.showBlock();         },                createMapMain: function() {            if(!this.mainMap){                this.mainMap = new VMapMain({parent: this});            }        },                removeMapMain: function() {            if(this.mainMap){                this.mainMap.remove();                this.mainMap = null;            }        },                increaseZoom: function() {            if(this.mainMap){                this.mainMap.increaseZoom();            }        },                decreaseZoom: function() {            if(this.mainMap){                this.mainMap.decreaseZoom();            }        },                showMarkBalloon: function(markId) {            if(this.mainMap){                this.mainMap.showMarkBalloon(markId);            }        },                hideMarkBalloon: function(markId) {            if(this.mainMap){                this.mainMap.hideMarkBalloon(markId);            }        },                setSelectedMark: function(markId) {            if(this.mainMap){                this.mainMap.setSelectedMark(markId);            }        },                generalEventsHanler: function() {            this.topControl.closePersonalBlock();        },                shareHz: function(url, pageUrl, title, description) {            var url  = url;            url += 'url='          + pageUrl;            url += '&title='       + title;            url += '&description=' + description;            //url += '&imageurl='    + encodeURIComponent(pimg);            this.popupSocial(url);        },        shareFb: function(url, pageUrl, title, summary, image) {            var url  = url;            url += '&p[title]='     + title;            url += '&p[summary]='   + summary;            url += '&p[url]='       + pageUrl;            url += '&p[images][0]=' + image;            this.popupSocial(url);        },        shareVk: function(url, pageUrl, title, description, image) {                        var url  = url;            url += 'url='          + pageUrl;            url += '&title='       + title;            url += '&description=' + description;            //url += '&image='       + encodeURIComponent('http://185.159.129.150:8085/img/mark_photos/dps_1.jpg');            url += '&noparse=true';            this.popupSocial(url);        },        popupSocial: function(url) {            window.open(url,'','toolbar=0,status=0,width=626,height=436');        },            });});